{% extends 'index.html' %}

{% block content %}
<div class="container">
    <h1>Object Detection Monitoring</h1>
    <video id="video" width="320" height="240" autoplay playsinline muted></video>
    <div id="prediction"></div>
    <br>
    <table id="detectionTable" class="table table-bordered">
        <thead>
            <tr>
                <th>시간</th>
                <th>객체</th>
                <th>객체 수</th>
            </tr>
        </thead>
        <tbody>
            <!-- 데이터가 여기에 추가됩니다 -->
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
<script>
    let webcam, model;

    async function setup() {
        // 모델 로드
        model = await mobilenet.load();
        webcam = await tf.data.webcam(document.getElementById('video'), {
            resizeWidth: 224,
            resizeHeight: 224,
        });

        // 1분마다 예측 실행
        setInterval(predict, 60000);

        // 기존 데이터 가져와 테이블에 추가
        fetchDataAndPopulateTable();
    }

    async function predict() {
        const image = await webcam.capture();
        const result = await model.classify(image);
        const prediction = result[0];
        const className = prediction.className;
        const probability = prediction.probability.toFixed(2);
        const currentTime = new Date().toISOString();  // ISO 형식으로 저장

        // 서버로 데이터 전송
        fetch('/save_detection/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                timestamp: currentTime,
                object_name: className,
                object_count: 1,
            }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Server response:', data);
            // 새로운 데이터 테이블에 추가
            addRowToTable(currentTime, className, 1);
        })
        .catch(err => console.error('Error:', err));

        image.dispose(); // 메모리 관리
    }

    function addRowToTable(timestamp, objectName, objectCount) {
        const table = document.getElementById("detectionTable").getElementsByTagName("tbody")[0];
        const newRow = table.insertRow();
        const timeCell = newRow.insertCell(0);
        const objectCell = newRow.insertCell(1);
        const countCell = newRow.insertCell(2);

        timeCell.textContent = timestamp;
        objectCell.textContent = objectName;
        countCell.textContent = objectCount;
    }

    function fetchDataAndPopulateTable() {
        // 서버에서 데이터 가져오기
        fetch('/get_detections/')
            .then(response => response.json())
            .then(data => {
                console.log('Existing data:', data);
                data.forEach(row => {
                    addRowToTable(row.timestamp, row.object_name, row.object_count);
                });
            })
            .catch(err => console.error('Error fetching data:', err));
    }

    setup();
</script>
{% endblock %}
