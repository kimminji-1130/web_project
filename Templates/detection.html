{% extends 'index.html' %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-4">탐지 내역</h2>

    <!-- 드롭다운 버튼 -->
    <div class="dropdown mb-2">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
            객체 선택
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <li><a class="dropdown-item" href="#" data-filter="all">전체</a></li>
            <li><a class="dropdown-item" href="#" data-filter="고라니">고라니</a></li>
            <li><a class="dropdown-item" href="#" data-filter="멧돼지">멧돼지</a></li>
            <li><a class="dropdown-item" href="#" data-filter="너구리">너구리</a></li>
            <li><a class="dropdown-item" href="#" data-filter="새">새</a></li>
            <li><a class="dropdown-item" href="#" data-filter="사람">사람</a></li>
        </ul>
    </div>

    <!-- 탐지 내역 표 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5> </h5>
        <div>
            <label for="rowsPerPage" class="form-label d-inline me-2"> </label>
            <select id="rowsPerPage" class="form-select d-inline w-auto">
                <option value="10">10개씩 보기</option>
                <option value="20">20개씩 보기</option>
                <option value="50">50개씩 보기</option>
                <option value="100">100개씩 보기</option>
            </select>
        </div>
    </div>

    <table class="table table-bordered" id="detectionTable">
        <thead>
            <tr>
                <th>시간</th>
                <th>객체</th>
                <th>객체 수</th>
            </tr>
        </thead>
        <tbody>
            {% for detection in detections %}
            <tr data-object="{{ detection.object_name }}">
                <td>{{ detection.timestamp }}</td>
                <td>{{ detection.object_name }}</td>
                <td>{{ detection.object_count }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- 페이지네이션 -->
    <nav>
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
</div>

<style>
    .table {
        text-align: center;
    }
    .dropdown-menu {
        max-height: 200px;
        overflow-y: auto;
    }
    .form-select {
        display: inline-block;
        width: auto;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dropdownItems = document.querySelectorAll('.dropdown-item');
        const tableRows = document.querySelectorAll('#detectionTable tbody tr');
        const rowsPerPageSelect = document.getElementById('rowsPerPage');
        const pagination = document.getElementById('pagination');
        let currentPage = 1;
        let rowsPerPage = parseInt(rowsPerPageSelect.value);

        // 필터링 기능
        dropdownItems.forEach(item => {
            item.addEventListener('click', function (event) {
                event.preventDefault();

                const filter = this.getAttribute('data-filter');
                tableRows.forEach(row => {
                    if (filter === 'all' || row.getAttribute('data-object') === filter) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });

                updatePagination();
                goToPage(1);
            });
        });

        // 표시 개수 변경 시 업데이트
        rowsPerPageSelect.addEventListener('change', function () {
            rowsPerPage = parseInt(this.value);
            updatePagination();
            goToPage(1);
        });

        // 페이지네이션 업데이트
        function updatePagination() {
            pagination.innerHTML = '';
            const visibleRows = Array.from(tableRows).filter(row => row.style.display !== 'none');
            const totalPages = Math.ceil(visibleRows.length / rowsPerPage);

            for (let i = 1; i <= totalPages; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = 'page-item';
                pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageItem.addEventListener('click', function (event) {
                    event.preventDefault();
                    goToPage(i);
                });
                pagination.appendChild(pageItem);
            }
        }

        // 특정 페이지로 이동
        function goToPage(page) {
            currentPage = page;
            const visibleRows = Array.from(tableRows).filter(row => row.style.display !== 'none');
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            visibleRows.forEach((row, index) => {
                row.style.display = index >= start && index < end ? '' : 'none';
            });

            Array.from(pagination.children).forEach((pageItem, index) => {
                pageItem.classList.toggle('active', index === currentPage - 1);
            });
        }

        // 초기화
        updatePagination();
        goToPage(1);
    });
</script>
{% endblock %}
